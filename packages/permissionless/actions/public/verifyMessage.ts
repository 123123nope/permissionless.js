import {
    type Address,
    type Chain,
    type Client,
    type Hex,
    type Transport,
    encodeDeployData,
    hashMessage
} from "viem"
import { call } from "viem/actions/public/call"
import { getAction } from "../../utils/getAction"

export const verifyMessage = async <
    TTransport extends Transport = Transport,
    TChain extends Chain | undefined = Chain | undefined
>(
    client: Client<TTransport, TChain>,
    {
        address,
        message,
        signature
    }: {
        address: Address
        message: string
        signature: Hex
    }
) => {
    const hash = hashMessage(message)

    const validateSigOffChain = encodeDeployData({
        abi: [
            {
                inputs: [
                    {
                        internalType: "address",
                        name: "_signer",
                        type: "address"
                    },
                    {
                        internalType: "bytes32",
                        name: "_hash",
                        type: "bytes32"
                    },
                    {
                        internalType: "bytes",
                        name: "_signature",
                        type: "bytes"
                    }
                ],
                stateMutability: "nonpayable",
                type: "constructor"
            }
        ],
        bytecode:
            "0x608060405234801561001057600080fd5b5060405161102538038061102583398101604081905261002f91610124565b600060405161003d906100dd565b604051809103906000f080158015610059573d6000803e3d6000fd5b5090506000816001600160a01b0316638f0684308686866040518463ffffffff1660e01b815260040161008e939291906101fb565b6020604051808303816000875af11580156100ad573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906100d19190610244565b9050806000526001601ff35b610db78061026e83390190565b634e487b7160e01b600052604160045260246000fd5b60005b8381101561011b578181015183820152602001610103565b50506000910152565b60008060006060848603121561013957600080fd5b83516001600160a01b038116811461015057600080fd5b6020850151604086015191945092506001600160401b038082111561017457600080fd5b818601915086601f83011261018857600080fd5b81518181111561019a5761019a6100ea565b604051601f8201601f19908116603f011681019083821181831017156101c2576101c26100ea565b816040528281528960208487010111156101db57600080fd5b6101ec836020830160208801610100565b80955050505050509250925092565b60018060a01b0384168152826020820152606060408201526000825180606084015261022e816080850160208701610100565b601f01601f191691909101608001949350505050565b60006020828403121561025657600080fd5b8151801515811461026657600080fd5b939250505056fe608060405234801561001057600080fd5b50610d97806100206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806376be4cea146100465780638f0684301461006d57806398ef1ed814610080575b600080fd5b6100596100543660046108bd565b610093565b604051901515815260200160405180910390f35b61005961007b366004610942565b610656565b61005961008e366004610942565b6106ee565b600073ffffffffffffffffffffffffffffffffffffffff87163b6060827f649264926492649264926492649264926492649264926492649264926492649288886100de60208261099e565b6100ea928b92906109de565b6100f391610a08565b14905080156101f9576000606089828a61010e60208261099e565b9261011b939291906109de565b8101906101289190610b1e565b955090925090508415806101395750865b156101f2576000808373ffffffffffffffffffffffffffffffffffffffff16836040516101669190610bb8565b6000604051808303816000865af19150503d80600081146101a3576040519150601f19603f3d011682016040523d82523d6000602084013e6101a8565b606091505b5091509150816101ef57806040517f9d0d6e2d0000000000000000000000000000000000000000000000000000000081526004016101e69190610c1e565b60405180910390fd5b50505b5050610233565b87878080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152509294505050505b808061023f5750600083115b15610430576040517f1626ba7e00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8b1690631626ba7e90610298908c908690600401610c38565b602060405180830381865afa9250505080156102ef575060408051601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe01682019092526102ec91810190610c51565b60015b610384573d80801561031d576040519150601f19603f3d011682016040523d82523d6000602084013e610322565b606091505b50851580156103315750600084115b15610350576103458b8b8b8b8b6001610093565b94505050505061064c565b806040517f6f2a95990000000000000000000000000000000000000000000000000000000081526004016101e69190610c1e565b7fffffffff0000000000000000000000000000000000000000000000000000000081167f1626ba7e00000000000000000000000000000000000000000000000000000000148015816103d4575086155b80156103e05750600085115b15610400576103f48c8c8c8c8c6001610093565b9550505050505061064c565b8415801561040b5750825b8015610415575087155b1561042457806000526001601ffd5b945061064c9350505050565b604187146104c0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603a60248201527f5369676e617475726556616c696461746f72237265636f7665725369676e657260448201527f3a20696e76616c6964207369676e6174757265206c656e67746800000000000060648201526084016101e6565b60006104cf6020828a8c6109de565b6104d891610a08565b905060006104ea604060208b8d6109de565b6104f391610a08565b905060008a8a604081811061050a5761050a610c93565b919091013560f81c915050601b811480159061052a57508060ff16601c14155b156105b7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602d60248201527f5369676e617475726556616c696461746f723a20696e76616c6964207369676e60448201527f617475726520762076616c75650000000000000000000000000000000000000060648201526084016101e6565b6040805160008152602081018083528e905260ff831691810191909152606081018490526080810183905273ffffffffffffffffffffffffffffffffffffffff8e169060019060a0016020604051602081039080840390855afa158015610622573d6000803e3d6000fd5b5050506020604051035173ffffffffffffffffffffffffffffffffffffffff161496505050505050505b9695505050505050565b6040517f76be4cea00000000000000000000000000000000000000000000000000000000815260009030906376be4cea906106a09088908890889088906001908990600401610cc2565b6020604051808303816000875af11580156106bf573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106e39190610d44565b90505b949350505050565b6040517f76be4cea00000000000000000000000000000000000000000000000000000000815260009030906376be4cea9061073790889088908890889088908190600401610cc2565b6020604051808303816000875af1925050508015610790575060408051601f3d9081017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016820190925261078d91810190610d44565b60015b61083a573d8080156107be576040519150601f19603f3d011682016040523d82523d6000602084013e6107c3565b606091505b508051600181900361083657816000815181106107e2576107e2610c93565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167f01000000000000000000000000000000000000000000000000000000000000001492506106e6915050565b8082fd5b90506106e6565b73ffffffffffffffffffffffffffffffffffffffff8116811461086357600080fd5b50565b60008083601f84011261087857600080fd5b50813567ffffffffffffffff81111561089057600080fd5b6020830191508360208285010111156108a857600080fd5b9250929050565b801515811461086357600080fd5b60008060008060008060a087890312156108d657600080fd5b86356108e181610841565b955060208701359450604087013567ffffffffffffffff81111561090457600080fd5b61091089828a01610866565b9095509350506060870135610924816108af565b91506080870135610934816108af565b809150509295509295509295565b6000806000806060858703121561095857600080fd5b843561096381610841565b935060208501359250604085013567ffffffffffffffff81111561098657600080fd5b61099287828801610866565b95989497509550505050565b818103818111156109d8577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b92915050565b600080858511156109ee57600080fd5b838611156109fb57600080fd5b5050820193919092039150565b803560208310156109d8577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff602084900360031b1b1692915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600082601f830112610a8457600080fd5b813567ffffffffffffffff80821115610a9f57610a9f610a44565b604051601f83017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f01168101908282118183101715610ae557610ae5610a44565b81604052838152866020858801011115610afe57600080fd5b836020870160208301376000602085830101528094505050505092915050565b600080600060608486031215610b3357600080fd5b8335610b3e81610841565b9250602084013567ffffffffffffffff80821115610b5b57600080fd5b610b6787838801610a73565b93506040860135915080821115610b7d57600080fd5b50610b8a86828701610a73565b9150509250925092565b60005b83811015610baf578181015183820152602001610b97565b50506000910152565b60008251610bca818460208701610b94565b9190910192915050565b60008151808452610bec816020860160208601610b94565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b602081526000610c316020830184610bd4565b9392505050565b8281526040602082015260006106e66040830184610bd4565b600060208284031215610c6357600080fd5b81517fffffffff0000000000000000000000000000000000000000000000000000000081168114610c3157600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b73ffffffffffffffffffffffffffffffffffffffff8716815285602082015260a060408201528360a0820152838560c0830137600060c085830181019190915292151560608201529015156080820152601f9092017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016909101019392505050565b600060208284031215610d5657600080fd5b8151610c31816108af56fea2646970667358221220ccc16aa1f284e04e16b5801de695d53d4a9586a1a7aec0e738f65344dfd181d464736f6c63430008170033",
        args: [address, hash, signature]
    })

    const isValid = getAction(
        client,
        call
    )({
        data: validateSigOffChain
    })

    console.log(isValid)
}
